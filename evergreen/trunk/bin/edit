#!/usr/bin/ruby -w

begin
  require 'fileutils.rb'
  have_fileutils = true
rescue LoadError
  have_fileutils = false
end
begin
  require 'pathname.rb'
  have_pathname = true
  # Cope with symbolic links to this script.
  edit_home = Pathname.new("#{__FILE__}/..").realpath().dirname()
  salma_hayek = Pathname.new("#{edit_home}/../salma-hayek").realpath()
rescue LoadError
  edit_bin = `dirname #{__FILE__}`.chomp()
  edit_home = "#{edit_bin}/.."
  salma_hayek = "#{edit_home}/../salma-hayek"
end
ENV["EDIT_HOME"] = edit_home

edit_class_name = "e.edit.Edit"
HOME = ENV["HOME"]
edit_preferences_directory = "#{HOME}/.#{edit_class_name}"

def openFileOnEditServer(edit_preferences_directory, filename)
  host = ENV["EDIT_HOME_SERVER"]
  if host == nil then
    host = 'localhost'
  end
  begin
    port = File.new("#{edit_preferences_directory}/edit-server-port").read()
    require 'net/telnet'
    telnet = Net::Telnet.new('Host' => host, 'Port' => port.to_i(), 'Telnetmode' => false)
    telnet.puts("open #{filename}\r")
    print(telnet.readlines().join(""))
    telnet.close()
    return true
  rescue
    return false
  end
end

# Translate vi/gvim line number specifications.
if ARGV[0] =~ /^\+(\d+)$/
  ARGV.shift
  ARGV[0] = "#{ARGV[0]}:#$1"
end

case `uname`.chomp
when /Darwin/
    # Darwin is what Mac OS X calls itself.
    edit_preferences_directory = "#{ENV["HOME"]}/Library/Preferences/#{edit_class_name}"
    os_specific_options = "-Xdock:name=Edit:icon=/Developer/Examples/Carbon/SimpleText/SimpleText.icns"
else
    extra_classpath_entries = "#{salma_hayek}/MRJ141Stubs.jar"
end

if File.stat(edit_preferences_directory).directory? == false
    puts("Edit: Couldn't find preferences directory '#{edit_preferences_directory}.")
    puts("Edit: Creating preferences directory '#{edit_preferences_directory}'.")
    Dir.mkdir(edit_preferences_directory)
    if have_fileutils
      puts("Edit: Copying default preferences.")
      FileUtils.cp("#{edit_home}/edit.properties-sample", "#{edit_preferences_directory}/edit.properties")
      puts("Edit: Away you go!")
    else
      puts("Edit: need Ruby 1.8")
    end
end

filename = ARGV[0]
if filename != nil && openFileOnEditServer(edit_preferences_directory, File.expand_path(filename))
  exit(0)
end

# Create a log file, and link to it as the newest.
# Symbolically linking to a file which doesn't exist yet is perfectly legal.
edit_log = "/tmp/edit.log.#$$"
if have_fileutils
  FileUtils.ln_sf(edit_log, "/tmp/edit.log")
end

fake_environment = ""
["CVS_RSH", "DISPLAY", "EDIT_HOME", "HOME", "JAVA_HOME", "PATH", "SHELL"].each() {
  |variable|
  value = ENV[variable]
  if value != nil
    fake_environment << " -Denv.#{variable}=#{value}"
  end
}

classpath = "-classpath #{edit_home}/classes:#{salma_hayek}/classes:#{extra_classpath_entries}"
heap_size = "-Xmx1g"

options = "#{os_specific_options} #{heap_size} #{fake_environment} #{classpath} -DpreferencesDirectory=#{edit_preferences_directory}"

if ENV["DEBUGGING_EDIT"] != nil
  system("java #{options} #{edit_class_name} #{filename}")
else
  system("java #{options} #{edit_class_name} #{filename} > #{edit_log} 2>&1 || cat #{edit_log} 1>&2 &")
end
