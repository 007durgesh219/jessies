#!/usr/bin/ruby -w

class Evergreen
    def initialize()
        require "fileutils.rb"
        require "pathname.rb"
        
        # Cope with symbolic links to this script.
        @project_root = Pathname.new(__FILE__).realpath().dirname().dirname()
        @salma_hayek = Pathname.new("#{@project_root}/../salma-hayek").realpath()
        require "#{@salma_hayek}/bin/invoke-java.rb"
        require "#{@salma_hayek}/bin/target-os.rb"
        require "#{@salma_hayek}/bin/show-alert.rb"
    end
    
    def launch()
        report_exceptions("Evergreen") { launch0() }
    end
    
    def launch0()
        home = ENV["HOME"]
        
        shouldBlock = false
        if ARGV[0] == "--block"
            ARGV.shift()
            shouldBlock = true
        end
        
        shouldCreateNewWorkspace = false
        if ARGV[0] == "--new-workspace"
            ARGV.shift()
            workspace_root = ARGV.shift()
            workspace_name = ARGV.shift()
            shouldCreateNewWorkspace = true
        end
        
        shouldCloseWorkspace = false
        if ARGV[0] == "--close-workspace"
            ARGV.shift()
            workspace_name = ARGV.shift()
            shouldCloseWorkspace = true
        end
        
        dot_directory = ENV["EVERGREEN_DOT_DIRECTORY"]
        if dot_directory == nil
            dot_directory = "#{home}/.e.edit.Edit"
            if target_os() == "Darwin"
                dot_directory = "#{home}/Library/Preferences/e.edit.Edit"
            end
        end
        
        if FileTest.directory?(dot_directory) == false
            FileUtils.mkdir_p(dot_directory)
        end
        
        serverPortPathname = Pathname.new(dot_directory) + "evergreen-server-port"
        # InAppClient's constructor stops anyone else from reading the .secret file.
        client = InAppClient.new(serverPortPathname)
        
        if shouldCreateNewWorkspace
            exit(send_command(client, "newWorkspace #{File.expand_path(workspace_root)}\t#{workspace_name}"))
        elsif shouldCloseWorkspace
            exit(send_command(client, "closeWorkspace #{workspace_name}"))
        end
        
        # Translate vi line number specifications.
        if ARGV[0] =~ /^\+(\d+)$/
            ARGV.shift()
            ARGV[0] = "#{ARGV[0]}:#$1"
        end
        
        # If we were given a filename, try to open it in an already-running instance.
        filename = ARGV[0]
        if filename != nil
            exit(send_command(client, "#{shouldBlock ? 'openAndBlock' : 'open'} #{File.expand_path(filename)}"))
        end
        
        invoker = Java.new("Evergreen", "e/util/Launcher")
        invoker.log_filename = "/tmp/edit.log.#$$"
        invoker.add_pathname_property("preferencesDirectory", dot_directory)
        invoker.add_property("e.gui.HelpMenu.hasManual", "true")
        invoker.add_property("e.gui.HelpMenu.supportAddress", "evergreen-users@googlegroups.com")
        invoker.add_property("e.gui.HelpMenu.supportSite", "http://groups.google.com/group/evergreen-users")
        invoker.invoke([ "Evergreen", "e.edit.EvergreenLaunchable" ])
    end
    
    def send_command(client, command)
        return client.trySendCommand(command) ? 0 : 1
    end
end

Evergreen.new().launch()
