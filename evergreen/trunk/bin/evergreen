#!/usr/bin/ruby -w

class Evergreen
    def initialize()
        require "fileutils.rb"
        require "pathname.rb"
        
        # Cope with symbolic links to this script.
        @project_root = Pathname.new(__FILE__).realpath().dirname().dirname()
        @salma_hayek = Pathname.new("#{@project_root}/../salma-hayek").realpath()
        require "#{@salma_hayek}/bin/invoke-java.rb"
        require "#{@salma_hayek}/bin/target-os.rb"
        require "#{@salma_hayek}/bin/show-alert.rb"
    end
    
    def launch()
        report_exceptions("Evergreen") { launch0() }
    end
    
    def launch0()
        home = ENV["HOME"]
        
        ENV["EDIT_HOME"] = convert_to_jvm_compatible_pathname(@project_root)
        
        shouldBlock = false
        if ARGV[0] == "--block"
            ARGV.shift()
            shouldBlock = true
        end
        
        shouldAddWorkspace = false
        if ARGV[0] == "--add-workspace"
            ARGV.shift()
            workspace_root = ARGV.shift()
            workspace_name = ARGV.shift()
            shouldAddWorkspace = true
        end
        
        shouldCloseWorkspace = false
        if ARGV[0] == "--close-workspace"
            ARGV.shift()
            workspace_name = ARGV.shift()
            shouldCloseWorkspace = true
        end
        
        dot_directory = ENV["EVERGREEN_DOT_DIRECTORY"]
        if dot_directory == nil
            dot_directory = "#{home}/.e.edit.Edit"
            if target_os() == "Darwin"
                dot_directory = "#{home}/Library/Preferences/e.edit.Edit"
            end
        end
        
        if FileTest.directory?(dot_directory) == false
            FileUtils.mkdir_p(dot_directory)
        end
        
        serverPortPathname = Pathname.new(dot_directory) + "edit-server-port"
        # InAppClient's constructor stops anyone else from reading the .secret file.
        client = InAppClient.new(serverPortPathname)
        
        if shouldAddWorkspace
            exit(client.trySendCommand("addWorkspace #{File.expand_path(workspace_root)}\t#{workspace_name}") ? 0 : 1)
        elsif shouldCloseWorkspace
            exit(client.trySendCommand("closeWorkspace #{workspace_name}") ? 0 : 1)
        end
        
        # Translate vi line number specifications.
        if ARGV[0] =~ /^\+(\d+)$/
            ARGV.shift()
            ARGV[0] = "#{ARGV[0]}:#$1"
        end
        
        filename = ARGV[0]
        if filename != nil && client.trySendCommand("#{shouldBlock ? 'openAndBlock' : 'open'} #{File.expand_path(filename)}")
            exit(0)
        end
        
        # FIXME: this isn't right if shouldBlock is true. We either need to pass the "shouldBlock" on to the Java side, or we need to wait until it's started up and "trySendCommand" again.
        if filename != nil
            ARGV.push(filename)
        end
        
        invoker = Java.new("Evergreen", "e/util/Launcher")
        invoker.log_filename = "/tmp/edit.log.#$$"
        invoker.add_pathname_property("preferencesDirectory", dot_directory)
        invoker.add_property("e.gui.HelpMenu.hasManual", "true")
        invoker.add_property("e.gui.HelpMenu.supportAddress", "evergreen-users@googlegroups.com")
        invoker.add_property("e.gui.HelpMenu.supportSite", "http://groups.google.com/group/evergreen-users")
        invoker.invoke([ "Evergreen", "e.edit.EvergreenLaunchable" ])
    end
end

Evergreen.new().launch()
